---
- name: Ensure Nginx reverse proxy base directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - "{{ nginx_rp_install_dir }}"
    - "{{ nginx_rp_config_dir }}"
    - "{{ nginx_rp_logs_dir }}"

- name: Ensure SSL directory for wildcard certificates exists
  ansible.builtin.file:
    path: "{{ nginx_rp_ssl_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Verify SSL certificate files exist
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ nginx_rp_ssl_dir }}/wildcard.lab.local.crt"
    - "{{ nginx_rp_ssl_dir }}/wildcard.lab.local.key"
    - "{{ nginx_rp_ssl_dir }}/root-ca.crt"
  register: nginx_rp_ssl_files_check

- name: Fail if SSL certificate is missing or is a directory
  ansible.builtin.fail:
    msg: "SSL file {{ item.item }} does not exist or is not a regular file"
  when: not item.stat.exists or item.stat.isdir
  loop: "{{ nginx_rp_ssl_files_check.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Verify SSL certificate validity
  ansible.builtin.command:
    cmd: "openssl x509 -in {{ nginx_rp_ssl_dir }}/wildcard.lab.local.crt -noout -checkend 86400"
  changed_when: false
  register: nginx_rp_cert_validity

- name: Warn if certificate expires in less than 1 day
  ansible.builtin.debug:
    msg: "WARNING: SSL certificate expires in less than 24 hours!"
  when: nginx_rp_cert_validity.rc != 0
