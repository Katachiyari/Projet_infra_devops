version: "3.9"

services:
  edgedoc:
    image: {{ edgedoc_image }}
    container_name: edgedoc
    restart: unless-stopped
    depends_on:
      - edgedoc-db
    ports:
      - "{{ edgedoc_port }}:3000"
    environment:
      - NODE_ENV=production
      - CMD_DOMAIN={{ edgedoc_domain }}
      - CMD_DB_URL=mysql://{{ edgedoc_db_user }}:{{ edgedoc_db_password }}@{{ edgedoc_db_host }}:{{ edgedoc_db_port }}/{{ edgedoc_db_name }}
      - CMD_DB_DIALECT=mariadb
      - CMD_ALLOW_ANONYMOUS=true
      - CMD_ALLOW_ANONYMOUS_EDITS=true
      - CMD_DEFAULT_PERMISSION=freely
      - CMD_SESSION_SECRET=please-change-me
    volumes:
      - "{{ edgedoc_install_dir }}/uploads:/hedgedoc/public/uploads"
    networks:
      - edgedoc_net
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  edgedoc-db:
    image: mariadb:10.11
    container_name: edgedoc-db
    restart: unless-stopped
    environment:
      - MARIADB_DATABASE={{ edgedoc_db_name }}
      - MARIADB_USER={{ edgedoc_db_user }}
      - MARIADB_PASSWORD={{ edgedoc_db_password }}
      - MARIADB_ROOT_PASSWORD={{ edgedoc_db_root_password }}
    volumes:
      - "{{ edgedoc_install_dir }}/db-data:/var/lib/mysql"
    networks:
      - edgedoc_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 5

networks:
  edgedoc_net:
    driver: bridge
