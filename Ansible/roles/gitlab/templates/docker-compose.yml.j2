---
# =============================================================================
# docker-compose.yml.j2
# =============================================================================
# Rôle : Déployer GitLab CE (Omnibus) + GitLab Runner via Docker Compose.
# Objectifs :
# - Exposer GitLab via Workhorse (HTTP interne) sur un port hôte configurable.
# - Exposer Git SSH sur un port hôte configurable (ex : 2222) pour éviter conflit avec sshd.
# - Exposer le Container Registry sur un port hôte configurable (ex : 5050), si activé.
# - Persister config/logs/data via volumes (disque hôte).
#
# Hypothèses d’architecture (SSOT) :
# - La terminaison TLS est assurée par le reverse-proxy Nginx (172.16.100.253).
# - Nginx Omnibus GitLab est désactivé ; Workhorse écoute en HTTP sur {{ gitlab_workhorse_port | default(8181) }}.
# - L’accès utilisateur se fait via {{ gitlab_external_url }} (ex : https://git-lab.lab.local).
#
# Bonnes pratiques :
# - Variables Ansible centralisées (defaults / group_vars / vault).
# - Aucune valeur sensible en dur (mot de passe / tokens via Vault).
# =============================================================================

services:
  # ===========================================================================
  # Service : gitlab
  # ===========================================================================
  # GitLab "Omnibus" embarque plusieurs composants et est administré via gitlab.rb.
  # La configuration est injectée via GITLAB_OMNIBUS_CONFIG.
  # ===========================================================================
  gitlab:
    # Image officielle GitLab CE, version pinée (reproductibilité).
    image: "gitlab/gitlab-ce:{{ gitlab_version }}"

    # Nom du conteneur : facilite l'exploitation (docker logs gitlab, etc.).
    container_name: gitlab

    # Hostname interne au conteneur (cohérent avec l’URL externe).
    hostname: "{{ gitlab_hostname }}"

    # Politique de redémarrage.
    restart: unless-stopped

    environment:
      # -----------------------------------------------------------------------
      # Configuration Omnibus (équivalent /etc/gitlab/gitlab.rb).
      # -----------------------------------------------------------------------
      GITLAB_OMNIBUS_CONFIG: |
        # URL externe (SSOT) : celle utilisée par les utilisateurs.
        external_url '{{ gitlab_external_url }}'

        # ---------------------------------------------------------------------
        # NGINX Omnibus :
        # Désactivé car la terminaison TLS et le routage sont réalisés par le reverse-proxy.
        # ---------------------------------------------------------------------
        nginx['enable'] = false

        # ---------------------------------------------------------------------
        # Workhorse :
        # Point d'entrée HTTP interne (backend du reverse-proxy).
        # ---------------------------------------------------------------------
        gitlab_workhorse['listen_network'] = "tcp"
        gitlab_workhorse['listen_addr'] = "0.0.0.0:{{ gitlab_workhorse_port | default(8181) }}"

        # ---------------------------------------------------------------------
        # Container Registry :
        # L’exposition via reverse-proxy doit être gérée séparément (vhost dédié).
        # ---------------------------------------------------------------------
        gitlab_rails['registry_enabled'] = true
        registry_external_url '{{ gitlab_registry_external_url }}'
        registry_nginx['enable'] = false

        # ---------------------------------------------------------------------
        # Sécurité :
        # Mot de passe root initial (provenant d'Ansible Vault).
        # ---------------------------------------------------------------------
        gitlab_rails['initial_root_password'] = '{{ gitlab_root_password }}'

        # ---------------------------------------------------------------------
        # SSH Git :
        # Permet à GitLab d'afficher le bon port dans "Clone SSH".
        # ---------------------------------------------------------------------
        gitlab_rails['gitlab_shell_ssh_port'] = {{ gitlab_ssh_port }}

        # ---------------------------------------------------------------------
        # Tuning (performances) basiques :
        # Ajustables selon RAM/CPU de la VM.
        # ---------------------------------------------------------------------
        postgresql['shared_buffers'] = "256MB"
        redis['maxmemory'] = '{{ gitlab_redis_maxmemory }}'

        # ---------------------------------------------------------------------
        # Observabilité :
        # Prometheus interne GitLab : activable si requis.
        # ---------------------------------------------------------------------
        prometheus['enable'] = {{ gitlab_prometheus_enabled | lower }}
        prometheus['listen_address'] = '0.0.0.0:9090'

        # Node exporter : exporter système (si activé).
        node_exporter['enable'] = {{ gitlab_node_exporter_enabled | lower }}

    ports:
      # -----------------------------------------------------------------------
      # Publication de ports (hôte -> conteneur)
      # -----------------------------------------------------------------------

      # Workhorse HTTP (backend reverse-proxy) :
      # Le reverse-proxy Nginx pointe vers http://{{ gitlab_ip }}:{{ gitlab_workhorse_port }}.
      - "{{ gitlab_workhorse_port | default(8181) }}:{{ gitlab_workhorse_port | default(8181) }}"

      # SSH Git (hôte -> conteneur 22).
      - "{{ gitlab_ssh_port }}:22"

      # Container Registry (hôte -> conteneur 5050).
      - "{{ gitlab_registry_port }}:5050"

      # Prometheus interne GitLab (optionnel).
      - "9090:9090"

    volumes:
      # -----------------------------------------------------------------------
      # Volumes persistants :
      # Sans ces volumes, une recréation du conteneur ferait perdre données/config.
      # -----------------------------------------------------------------------
      - "{{ gitlab_config_dir }}:/etc/gitlab"
      - "{{ gitlab_logs_dir }}:/var/log/gitlab"
      - "{{ gitlab_data_dir }}:/var/opt/gitlab"

    shm_size: "256m"

    networks:
      - gitlab-network

    # -------------------------------------------------------------------------
    # Healthcheck :
    # Vérifie que Workhorse répond localement (prérequis avant exposition externe).
    # -------------------------------------------------------------------------
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://127.0.0.1:{{ gitlab_workhorse_port | default(8181) }}/help >/dev/null || exit 1"
        ]
      interval: 30s
      timeout: 5s
      retries: 30
      start_period: 120s

  # ===========================================================================
  # Service : gitlab-runner
  # ===========================================================================
  # GitLab Runner exécute les jobs CI/CD.
  # Utilise le Docker executor avec montage de /var/run/docker.sock.
  # ===========================================================================
  gitlab-runner:
    image: "gitlab/gitlab-runner:{{ gitlab_runner_version }}"
    container_name: gitlab-runner
    restart: unless-stopped

    volumes:
      # Configuration persistante du Runner.
      - "{{ gitlab_runner_config_dir }}:/etc/gitlab-runner"

      # Accès au démon Docker hôte (puissant).
      - /var/run/docker.sock:/var/run/docker.sock

      # Cache CI.
      - "{{ gitlab_runner_cache_dir }}:/cache"

    depends_on:
      gitlab:
        condition: service_healthy

    networks:
      - gitlab-network

    healthcheck:
      test: ["CMD-SHELL", "gitlab-runner --version >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 30s

networks:
  gitlab-network:
    driver: bridge
