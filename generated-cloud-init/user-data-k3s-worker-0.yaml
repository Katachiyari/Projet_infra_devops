#cloud-config
hostname: k3s-worker-0
manage_etc_hosts: true

# Cr√©ation de l'utilisateur ansible (bonnes pratiques officielles)
users:
  - name: ansible
    groups: [adm, sudo]
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE30vg7EchnxPkkVvAnbi0Ey55NGWRiUNE1ClsUvCj7d vm-common-key

package_update: true
package_upgrade: true

packages:
  - qemu-guest-agent
  - sudo
  - python3
  - python3-pip

write_files:
  - path: /etc/ssh/sshd_config.d/99-ansible-hardening.conf
    permissions: "0644"
    content: |
      PasswordAuthentication no
      PubkeyAuthentication yes
      PermitRootLogin no

runcmd:
  - [ systemctl, enable, --now, qemu-guest-agent ]
  - [ systemctl, restart, ssh ]
  - [ chown, -R, 'ansible:ansible', '/home/ansible' ]
