# ğŸ¤– Prompt pour IA : DÃ©ploiement Stack Monitoring

***

```markdown
# CONTEXTE PROJET

Tu es un expert DevSecOps. Tu travailles sur un projet d'infrastructure Proxmox existant gÃ©rÃ© avec Terraform et Ansible.

## INFRASTRUCTURE EXISTANTE

### VMs dÃ©jÃ  dÃ©ployÃ©es
- `dns-server` (172.16.100.254) : Bind9 configurÃ©
- `harbor` (172.16.100.2) : Harbor Registry Docker
- `tools-manager` (172.16.100.20) : Taiga + EdgeDoc
- `gitlab` (172.16.100.30) : GitLab CE

### Architecture Terraform/Ansible en place
```
projet-infra-devops/
â”œâ”€â”€ terraform.tfvars          # SSOT VMs
â”œâ”€â”€ main.tf                   # Provisionnement Proxmox
â”œâ”€â”€ provider.tf
â”œâ”€â”€ variables.tf
â”‚
â””â”€â”€ Ansible/
    â”œâ”€â”€ inventory/
    â”‚   â””â”€â”€ terraform.generated.yml
    â”‚
    â”œâ”€â”€ group_vars/
    â”‚   â”œâ”€â”€ all.yml           # Config globale
    â”‚   â””â”€â”€ dns_hosts.yml     # Config Bind9
    â”‚
    â”œâ”€â”€ roles/
    â”‚   â”œâ”€â”€ common/           # Docker, firewall, base
    â”‚   â”œâ”€â”€ bind9/            # DNS
    â”‚   â”œâ”€â”€ harbor/           # Registry
    â”‚   â”œâ”€â”€ taiga/            # Gestion projet
    â”‚   â”œâ”€â”€ edgedoc/          # Documentation
    â”‚   â””â”€â”€ gitlab/           # Git + CI/CD
    â”‚
    â””â”€â”€ playbooks/
        â”œâ”€â”€ site.yml
        â”œâ”€â”€ bind9.yml
        â”œâ”€â”€ harbor.yml
        â””â”€â”€ gitlab.yml
```

### Standards du projet (IMPÃ‰RATIFS)
- âœ… **Idempotence stricte** : tout doit Ãªtre rejouable sans erreur
- âœ… **SSOT** : une seule source de vÃ©ritÃ© par configuration
- âœ… **Docker Compose officiel** : pas de containers standalone
- âœ… **Documentation officielle uniquement** : Prometheus, Grafana, Alertmanager docs
- âœ… **DevSecOps** : sÃ©curitÃ© dÃ¨s la conception (pas de root, secrets chiffrÃ©s, firewall)
- âœ… **DNS intÃ©grÃ©** : ajout automatique dans Bind9
- âœ… **Progressif** : version simple d'abord, complexitÃ© ajoutÃ©e aprÃ¨s validation

### Outils disponibles
- Proxmox VE 9.1.1
- Terraform avec provider `bpg/proxmox`
- Ansible 2.16+
- Ubuntu 24.04 LTS (templates cloud-init)
- Docker Engine + Docker Compose v2
- Bind9 pour DNS interne (zone `lab.local`)

---

# MISSION

CrÃ©er une **nouvelle VM `monitoring-stack`** avec Prometheus + Grafana + Alertmanager sur une seule machine.

## SPÃ‰CIFICATIONS VM

```yaml
monitoring-stack:
  ip: 172.16.100.40
  hostname: monitoring.lab.local
  cpu: 2
  ram: 4096 MB
  disk: 50 GB
  bridge: vmbr0
  pool: production
  tags: [monitoring, observability, prod]
```

## SERVICES Ã€ DÃ‰PLOYER (Stack unique)

### 1. Prometheus
- **Version** : Latest stable (v2.48+)
- **Port** : 9090
- **RÃ´le** : Collecte mÃ©triques (scraping)
- **Targets** : 
  - Node Exporter (toutes VMs)
  - cAdvisor (Docker containers)
  - Harbor metrics (si activÃ©)
  - GitLab metrics (si activÃ©)
- **RÃ©tention** : 15 jours
- **Storage** : `/data/prometheus`

### 2. Grafana
- **Version** : Latest stable (v10.2+)
- **Port** : 3000
- **RÃ´le** : Visualisation dashboards
- **Datasource** : Prometheus (auto-configurÃ©)
- **Dashboards** : Import automatique (Node Exporter, Docker)
- **Auth** : Admin password (Ansible Vault)
- **Storage** : `/data/grafana`

### 3. Alertmanager
- **Version** : Latest stable (v0.26+)
- **Port** : 9093
- **RÃ´le** : Gestion alertes
- **Notifications** : Email (SMTP) + webhook (optionnel)
- **Storage** : `/data/alertmanager`

### 4. Node Exporter (sur TOUTES les VMs)
- **Version** : Latest stable
- **Port** : 9100
- **RÃ´le** : MÃ©triques systÃ¨me (CPU, RAM, disk, network)
- **DÃ©ploiement** : Systemd service (pas Docker pour Ã©viter dÃ©pendance)

---

# LIVRABLES ATTENDUS

## 1. Terraform

### Fichier `terraform.tfvars` (ajout VM)
Ajouter l'entrÃ©e `monitoring-stack` dans le map `nodes` existant.

### Pas de modification des autres fichiers Terraform
La structure existante doit fonctionner sans changement.

---

## 2. Ansible

### A. RÃ´le `monitoring` (NOUVEAU)

**Structure** :
```
roles/monitoring/
â”œâ”€â”€ defaults/main.yml       # Variables par dÃ©faut
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ main.yml           # Orchestration
â”‚   â”œâ”€â”€ prerequisites.yml   # Docker, dirs, firewall
â”‚   â”œâ”€â”€ prometheus.yml      # Config Prometheus
â”‚   â”œâ”€â”€ grafana.yml         # Config Grafana
â”‚   â””â”€â”€ alertmanager.yml    # Config Alertmanager
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ docker-compose.yml.j2
â”‚   â”œâ”€â”€ prometheus.yml.j2
â”‚   â”œâ”€â”€ alertmanager.yml.j2
â”‚   â”œâ”€â”€ grafana-datasources.yml.j2
â”‚   â””â”€â”€ alert-rules.yml.j2
â”œâ”€â”€ handlers/main.yml       # Restart services
â””â”€â”€ files/
    â””â”€â”€ dashboards/         # Dashboards JSON Grafana
        â”œâ”€â”€ node-exporter.json
        â””â”€â”€ docker-containers.json
```

**FonctionnalitÃ©s** :
- Installation Docker Compose stack (idempotent)
- Configuration Prometheus avec auto-discovery des targets depuis inventaire Ansible
- Configuration Grafana avec datasource Prometheus
- Import automatique dashboards Grafana
- Configuration Alertmanager avec rÃ¨gles de base
- Firewall UFW (ports 9090, 3000, 9093)
- Backup automatique `/data/monitoring` (optionnel)

### B. RÃ´le `node_exporter` (NOUVEAU)

**Structure** :
```
roles/node_exporter/
â”œâ”€â”€ defaults/main.yml
â”œâ”€â”€ tasks/main.yml
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ node_exporter.service.j2
â””â”€â”€ handlers/main.yml
```

**FonctionnalitÃ©s** :
- Installation Node Exporter (binaire officiel)
- Service systemd
- Firewall (port 9100 depuis monitoring-stack uniquement)
- Idempotent

### C. Fichier `group_vars/monitoring_hosts.yml` (NOUVEAU)

Variables SSOT pour la stack monitoring :
```yaml
# Versions (sources officielles)
prometheus_version: "v2.48.0"
grafana_version: "10.2.3"
alertmanager_version: "v0.26.0"
node_exporter_version: "1.7.0"

# RÃ©seau
monitoring_hostname: "monitoring.lab.local"

# Stockage
monitoring_data_volume: "/data/monitoring"

# Prometheus
prometheus_port: 9090
prometheus_retention_days: 15
prometheus_scrape_interval: "15s"

# Auto-discovery targets depuis inventaire
prometheus_targets:
  - job_name: node-exporter
    static_configs:
      - targets: # AUTO-GÃ‰NÃ‰RÃ‰ depuis groups['all']

# Grafana
grafana_port: 3000
grafana_admin_user: admin
grafana_admin_password: "{{ vault_grafana_admin_password }}"

# Alertmanager
alertmanager_port: 9093
alertmanager_smtp_host: "smtp.lab.local"
alertmanager_smtp_from: "alertmanager@lab.local"
alertmanager_smtp_to: "admin@lab.local"
```

### D. Fichier `secrets/monitoring.vault` (NOUVEAU)

Secrets chiffrÃ©s Ansible Vault :
```yaml
vault_grafana_admin_password: "Graf@naAdm!n2024"
vault_alertmanager_smtp_password: "SmtpP@ss2024"
```

### E. Playbook `playbooks/monitoring.yml` (NOUVEAU)

```yaml
***
- name: DÃ©ploiement Stack Monitoring
  hosts: monitoring_hosts
  become: true
  
  roles:
    - common              # PrÃ©requis (Docker)
    - monitoring          # Stack complÃ¨te

- name: Installation Node Exporter (toutes VMs)
  hosts: all
  become: true
  
  roles:
    - node_exporter
```

---

## 3. DNS (Bind9)

### Modification `group_vars/dns_hosts.yml`

Ajouter les enregistrements DNS :
```yaml
bind9_zones:
  - name: "lab.local"
    records:
      # ... (enregistrements existants)
      
      # Monitoring Stack
      - name: "monitoring"
        type: A
        value: "172.16.100.40"
      
      - name: "grafana"
        type: CNAME
        value: "monitoring.lab.local."
      
      - name: "prometheus"
        type: CNAME
        value: "monitoring.lab.local."
      
      - name: "alertmanager"
        type: CNAME
        value: "monitoring.lab.local."
```

---

## 4. Documentation

### Fichier `docs/monitoring-stack.md` (NOUVEAU)

Documentation complÃ¨te :
- Architecture de la stack
- Configuration Prometheus (targets, rules)
- Dashboards Grafana disponibles
- Configuration alertes
- Commandes maintenance (backup, restore)
- Troubleshooting

---

# CONTRAINTES TECHNIQUES

## SÃ©curitÃ© DevSecOps
- âŒ Pas de `latest` tag Docker (versions explicites)
- âœ… Utilisateurs non-root dans containers
- âœ… Secrets dans Ansible Vault uniquement
- âœ… Firewall UFW strict (ports minimum)
- âœ… HTTPS pour Grafana (certificat auto-signÃ© ou Let's Encrypt)
- âœ… Authentification activÃ©e (pas d'accÃ¨s anonyme)

## Idempotence
- Tous les tasks Ansible doivent Ãªtre rejouables sans erreur
- Utiliser modules Ansible (`docker_compose`, `template`, `file`) pas `shell`
- Handlers pour restart services uniquement si config change

## Performance
- Prometheus : scrape interval 15s (pas moins)
- RÃ©tention 15 jours maximum (petit lab)
- Grafana : pas de plugins externes (version de base)

## IntÃ©gration inventaire Ansible
- Auto-discovery targets Prometheus depuis `groups['all']`
- Pas de hardcoding d'IPs (utiliser `hostvars`)

---

# COMMANDES DE DÃ‰PLOIEMENT ATTENDUES

```bash
# 1. CrÃ©er VM
terraform apply -target=proxmox_virtual_environment_vm.vm[\"monitoring-stack\"]

# Attendre cloud-init
sleep 60

# 2. DÃ©ployer stack monitoring
cd Ansible/
ansible-playbook playbooks/monitoring.yml --ask-vault-pass

# 3. Installer Node Exporter partout
ansible-playbook playbooks/monitoring.yml --tags node_exporter

# 4. Mettre Ã  jour DNS
ansible-playbook playbooks/bind9.yml

# 5. Valider
curl http://monitoring.lab.local:9090/targets       # Prometheus targets
curl http://grafana.lab.local:3000/api/health      # Grafana health
```

---

# VALIDATION FINALE

## Tests de fonctionnement
- [ ] Prometheus UI accessible : `http://monitoring.lab.local:9090`
- [ ] Prometheus scrape toutes les VMs (Node Exporter)
- [ ] Grafana UI accessible : `http://grafana.lab.local:3000`
- [ ] Login Grafana avec admin password
- [ ] Datasource Prometheus configurÃ© automatiquement
- [ ] Dashboards importÃ©s visibles
- [ ] Alertmanager UI accessible : `http://monitoring.lab.local:9093`
- [ ] RÃ©solution DNS : `dig monitoring.lab.local @172.16.100.254`
- [ ] Firewall : ports 9090, 3000, 9093 ouverts uniquement

## Tests idempotence
```bash
# Rejouer sans erreur
ansible-playbook playbooks/monitoring.yml --ask-vault-pass
# â†’ 0 changed, 0 failed
```

---

# FORMAT DE RÃ‰PONSE ATTENDU

Fournis le code complet des fichiers suivants dans l'ordre :

1. **terraform.tfvars** (extrait ajout VM)
2. **group_vars/monitoring_hosts.yml** (complet)
3. **secrets/monitoring.vault** (complet)
4. **roles/monitoring/defaults/main.yml** (complet)
5. **roles/monitoring/tasks/main.yml** (complet)
6. **roles/monitoring/templates/docker-compose.yml.j2** (complet)
7. **roles/monitoring/templates/prometheus.yml.j2** (complet)
8. **roles/monitoring/templates/alertmanager.yml.j2** (complet)
9. **roles/monitoring/templates/grafana-datasources.yml.j2** (complet)
10. **roles/node_exporter/tasks/main.yml** (complet)
11. **roles/node_exporter/templates/node_exporter.service.j2** (complet)
12. **playbooks/monitoring.yml** (complet)
13. **group_vars/dns_hosts.yml** (extrait ajout DNS)
14. **docs/monitoring-stack.md** (complet)

Pour chaque fichier :
- Chemin complet
- RÃ´le (SSOT ou non)
- Code complet avec commentaires explicatifs
- Aucun placeholder (`...`, `# TODO`, etc.)

Utilise UNIQUEMENT les documentations officielles :
- https://prometheus.io/docs/prometheus/latest/
- https://grafana.com/docs/grafana/latest/
- https://prometheus.io/docs/alerting/latest/alertmanager/

Commence maintenant.
```

***

