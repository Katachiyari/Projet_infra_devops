
# Terraform

Provisionnement automatis√© des VMs sur Proxmox
G√©n√©ration dynamique de l'inventaire Ansible (terraform.generated.yml)
Injection des cl√©s SSH publiques pour l'utilisateur¬†ansible
Configuration du provider Proxmox

Super, explique en d√©tails le fonctionnement de ces √©tapes, du lancement de la premieres commande.

J'ai le projet github dans une fenetre du navigateur, je veux suivre ce que tu m'explique avec les fichier sous les yeux

Parfait ! Maintenant je vais vous expliquer **le cycle complet** du provisionnement Terraform, du d√©but √† la fin.

***

## üìã √âtape 0 : Pr√©paration (Avant la premi√®re commande)

### Fichier √† cr√©er : `terraform.tfvars`

Vous devez cr√©er ce fichier **√† la racine du projet** en vous basant sur `terraform.tfvars.example`. Ce fichier contient vos secrets et ne doit **JAMAIS** √™tre versionn√©.

**Contenu typique :**

```hcl
proxmox_endpoint  = "https://10.250.250.4:8006/"
proxmox_api_token = "ansible@pve!terraform=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
proxmox_insecure  = true

node_name          = "pve4"
template_vmid      = 9000
datastore_vm       = "local-lvm"
datastore_snippets = "jdk_snippets"

gateway     = "172.16.100.1"
cidr_suffix = 24

ssh_public_key = "ssh-ed25519 AAAAC3Nza... votre_cle_publique"

nodes = {
  tools-manager = {
    ip     = "172.16.100.20"
    cpu    = 2
    mem    = 4096
    disk   = 60
    bridge = "vmbr23"
    tags   = ["tools", "ansible"]
  }
}
```

**Regardez :** `variables.tf` (lignes 1-72) d√©finit toutes ces variables.

***

## üîß √âtape 1 : `terraform init`

### Que fait cette commande ?

**Fichier concern√© :** `provider.tf` (lignes 1-19)

```bash
terraform init
```

**Actions ex√©cut√©es :**

1. **T√©l√©chargement des providers** :
    - Provider Proxmox (`bpg/proxmox` version >= 0.92.0)
    - Provider Local (`hashicorp/local` version >= 2.4.0)
    - Stock√©s dans `.terraform/providers/`
2. **Initialisation du backend** :
    - Par d√©faut : backend local (state stock√© localement)
    - Cr√©e `.terraform/` et `.terraform.lock.hcl`
3. **Validation de la configuration** :
    - V√©rifie la syntaxe HCL des fichiers `*.tf`

**R√©sultat :** Terraform est pr√™t √† communiquer avec l'API Proxmox.

***

## üîç √âtape 2 : `terraform plan -input=false`

### Que fait cette commande ?

**Fichiers concern√©s :** `main.tf`, `variables.tf`, `terraform.tfvars`, `ansible_inventory.tf`

```bash
terraform plan -input=false
```

**Actions ex√©cut√©es :**

### 2.1 Chargement des variables (`variables.tf` + `terraform.tfvars`)

Terraform charge :

- `proxmox_endpoint` ‚Üí URL de l'API Proxmox
- `proxmox_api_token` ‚Üí Token d'authentification (format `user@realm!token=SECRET`)
- `template_vmid` ‚Üí ID du template cloud-init (ex: 9000)
- `ssh_public_key` ‚Üí Votre cl√© publique SSH
- `nodes` ‚Üí Map contenant la d√©finition de chaque VM


### 2.2 Connexion √† l'API Proxmox (`provider.tf` lignes 14-18)

```hcl
provider "proxmox" {
  endpoint  = var.proxmox_endpoint
  api_token = var.proxmox_api_token
  insecure  = var.proxmox_insecure
}
```

Terraform √©tablit une connexion HTTPS √† Proxmox avec le token API.

### 2.3 Calcul du plan d'ex√©cution (`main.tf`)

**Pour chaque VM dans `var.nodes`** (boucle `for_each`) :

```hcl
resource "proxmox_virtual_environment_vm" "vm" {
  for_each  = var.nodes
  name      = each.key  # Nom de la VM (ex: "tools-manager")
```

Terraform calcule ce qu'il doit cr√©er :

**Exemple pour la VM `tools-manager` :**

- **Nom** : `tools-manager`
- **Node Proxmox** : `pve4`
- **Tags** : `["ansible", "tools"]` (tri√©s et en minuscules)
- **Clone** : Depuis le template VMID `9000`
- **CPU** : 2 c≈ìurs
- **RAM** : 4096 MB
- **Disque** : 60 GB sur `local-lvm` (interface SCSI0)
- **R√©seau** : Interface `virtio` sur bridge `vmbr23`


### 2.4 Configuration r√©seau via cloud-init (`main.tf` lignes 32-46)

```hcl
initialization {
  ip_config {
    ipv4 {
      address = format("%s/%d", each.value.ip, var.cidr_suffix)
      gateway = var.gateway
    }
  }

  user_account {
    username = "ansible"
    keys     = [var.ssh_public_key]
  }
}
```

**Ce qui est inject√© dans cloud-init :**

- IP statique : `172.16.100.20/24`
- Gateway : `172.16.100.1`
- **Utilisateur `ansible`** avec votre cl√© SSH publique
- Qemu-guest-agent activ√©


### 2.5 G√©n√©ration de l'inventaire Ansible (`ansible_inventory.tf`)

**Fichier de sortie :** `Ansible/inventory/terraform.generated.yml`

**Logique :**

```hcl
locals {
  ansible_hosts = {
    for name, n in var.nodes :
    name => {
      ansible_host = n.ip
    }
  }
}
```

**Mapping des tags vers les groupes Ansible :**

Si une VM a le tag `tools`, elle sera ajout√©e au groupe `taiga_hosts`.
Si elle a le tag `bind9` ou `dns`, elle ira dans `bind9_hosts`.

**Exemple de fichier g√©n√©r√© :**

```yaml
all:
  hosts:
    tools-manager:
      ansible_host: 172.16.100.20
    bind9dns:
      ansible_host: 172.16.100.254
  children:
    taiga_hosts:
      hosts:
        tools-manager: {}
    bind9_hosts:
      hosts:
        bind9dns: {}
```

**R√©sultat du plan :**

- Affichage des ressources √† cr√©er (+)
- Affichage des ressources √† modifier (~)
- Affichage des ressources √† d√©truire (-)

***

## üöÄ √âtape 3 : `terraform apply -input=false`

### Que fait cette commande ?

```bash
terraform apply -input=false
```

**Actions ex√©cut√©es :**

### 3.1 Appel API Proxmox : Clonage du template

**Pour chaque VM :**

1. **Appel API** : `POST /api2/json/nodes/{node}/qemu/{template_vmid}/clone`
    - Cr√©ation d'une VM √† partir du template cloud-init
    - Assignation d'un nouveau VMID
2. **Configuration des ressources** :
    - CPU : 2 c≈ìurs
    - RAM : 4096 MB
    - Disque : Resize √† 60 GB
3. **Configuration r√©seau** :
    - Bridge : `vmbr23`
    - Mod√®le : `virtio`

### 3.2 Injection cloud-init via l'API Proxmox

**Appel API** : `PUT /api2/json/nodes/{node}/qemu/{vmid}/config`

**Param√®tres inject√©s :**

- `ipconfig0` : `ip=172.16.100.20/24,gw=172.16.100.1`
- `ciuser` : `ansible`
- `sshkeys` : Votre cl√© publique SSH (URL-encod√©e)

**Ce que cloud-init fera au premier boot :**

- Cr√©ation de l'utilisateur `ansible`
- Ajout de la cl√© SSH dans `/home/ansible/.ssh/authorized_keys`
- Configuration r√©seau statique
- Installation de qemu-guest-agent (si dans le snippet)
- Durcissement SSH (si dans le snippet)


### 3.3 D√©marrage des VMs

**Appel API** : `POST /api2/json/nodes/{node}/qemu/{vmid}/status/start`

Les VMs d√©marrent et cloud-init s'ex√©cute automatiquement.

### 3.4 √âcriture du State Terraform

**Fichier cr√©√©/mis √† jour :** `terraform.tfstate`

Contient :

- Liste de toutes les ressources cr√©√©es
- IDs Proxmox (VMID)
- M√©tadonn√©es (IPs, configs)

‚ö†Ô∏è **S√©curit√© :** Ce fichier contient des infos sensibles, ne le versionnez pas (actuellement versionn√© dans votre projet).

### 3.5 G√©n√©ration de l'inventaire Ansible

**Fichier cr√©√© :** `Ansible/inventory/terraform.generated.yml`

Ce fichier est cr√©√©/mis √† jour automatiquement par la ressource `local_file` :

```hcl
resource "local_file" "ansible_inventory" {
  filename        = "${path.module}/Ansible/inventory/terraform.generated.yml"
  content         = yamlencode(local.ansible_inventory)
  file_permission = "0644"
}
```

**R√©sultat :** L'inventaire Ansible est pr√™t, synchronis√© avec l'√©tat r√©el de l'infrastructure.

***

## ‚úÖ V√©rification : Connexion SSH automatique

### Pourquoi √ßa fonctionne sans configuration manuelle ?

1. **Terraform** a inject√© votre cl√© SSH publique via `user_account.keys`
2. **Cloud-init** a cr√©√© l'utilisateur `ansible` avec cette cl√©
3. **L'inventaire Ansible** contient les bonnes IPs

### Test de connexion :

```bash
ssh -i ~/.ssh/votre_cle_privee ansible@172.16.100.20
```

Ou via Ansible :

```bash
cd Ansible/
./run-ping-test.sh
```


***

## üîÑ R√©sum√© du flux complet

```
1. terraform init
   ‚îî‚îÄ> T√©l√©charge providers (Proxmox + Local)
   ‚îî‚îÄ> Initialise le backend

2. terraform plan
   ‚îî‚îÄ> Lit terraform.tfvars
   ‚îî‚îÄ> Se connecte √† l'API Proxmox
   ‚îî‚îÄ> Calcule les VMs √† cr√©er
   ‚îî‚îÄ> Calcule l'inventaire Ansible
   ‚îî‚îÄ> Affiche le plan (sans rien ex√©cuter)

3. terraform apply
   ‚îî‚îÄ> Clone le template cloud-init pour chaque VM
   ‚îî‚îÄ> Configure CPU/RAM/Disque
   ‚îî‚îÄ> Injecte cloud-init (IP + user ansible + cl√© SSH)
   ‚îî‚îÄ> D√©marre les VMs
   ‚îî‚îÄ> G√©n√®re terraform.tfstate
   ‚îî‚îÄ> √âcrit Ansible/inventory/terraform.generated.yml

4. Premier boot VM
   ‚îî‚îÄ> Cloud-init cr√©e l'utilisateur ansible
   ‚îî‚îÄ> Cloud-init configure le r√©seau
   ‚îî‚îÄ> Cloud-init installe qemu-guest-agent
   ‚îî‚îÄ> Cloud-init durcit SSH

5. Connexion Ansible automatique
   ‚îî‚îÄ> Ansible lit terraform.generated.yml
   ‚îî‚îÄ> Ansible se connecte via la cl√© SSH inject√©e
```


***

## üìÅ Fichiers √† suivre dans GitHub

| Fichier | R√¥le |
| :-- | :-- |
| `provider.tf` | Configuration des providers Terraform |
| `variables.tf` | D√©finition de toutes les variables |
| `terraform.tfvars.example` | Exemple de configuration (√† copier) |
| `main.tf` | Cr√©ation des VMs Proxmox |
| `ansible_inventory.tf` | G√©n√©ration de l'inventaire Ansible |
| `Ansible/inventory/terraform.generated.yml` | Inventaire g√©n√©r√© automatiquement |


***

Vous avez maintenant une vision compl√®te du fonctionnement.



Question et r√©ponse synth√©tique :
Pour quoi passer par une image cloud-init ?
A quoi sert le fichier [user-data.yaml.tftpl](https://github.com/Katachiyari/Projet_infra_devops/blob/main/cloud-init/user-data.yaml.tftpl) ?
Comment √ßa fonctionne ?

Qemu-guest-agent c'est quoi, a quoi sa sert ?

Appel API¬†:¬†POST /api2/json/nodes/{node}/qemu/{template_vmid}/clone :
Sur le protocole http ?

Installation de qemu-guest-agent (si dans le snippet)
Quels sont les √©tapes pour cr√©er le snippets
Comment est t'il d√©clar√© ?
A quoi sa sert et comment sa vie ?

Comment faire, selon la m√©thode officiel et best practice :
Si je modifie une config machine ?
Si je modifie le r√©seau ?
Si je modifie cloud-init ?

Parfait ! Je vais r√©pondre √† toutes vos questions de mani√®re synth√©tique et professionnelle.

***

## üî∑ Pourquoi passer par une image cloud-init ?

**Avantages officiels Proxmox  :**[^1][^2]

- **Automatisation compl√®te** : injection automatique des credentials, IP, hostname, cl√©s SSH
- **Idempotence** : reproductibilit√© garantie pour chaque VM clon√©e
- **Rapidit√©** : clonage instantan√© vs installation manuelle (15-20 min √©conomis√©es par VM)
- **Standard industriel** : utilis√© par AWS, Azure, GCP (interop√©rabilit√©)
- **DevOps-ready** : int√©gration native avec Terraform et Ansible

**Vs installation manuelle :**

- Template cloud-init ‚Üí 30 secondes de clonage
- Installation ISO ‚Üí 15-20 minutes par VM + configuration manuelle

***

## üî∑ R√¥le du fichier `user-data.yaml.tftpl`

**Fonction  :**[^3][^1]
C'est un **template Terraform** (`.tftpl`) qui g√©n√®re le fichier `user-data` pour cloud-init. Il d√©finit la configuration post-boot de la VM.

**Contenu d√©compos√© :**


| Section | R√¥le |
| :-- | :-- |
| `users` | Cr√©ation de l'utilisateur `ansible` avec cl√© SSH et droits sudo sans mot de passe |
| `packages` | Installation de `qemu-guest-agent`, `python3`, `sudo` |
| `write_files` | Durcissement SSH (d√©sactivation password auth, root login) |
| `runcmd` | Commandes d'initialisation (d√©marrage qemu-guest-agent, red√©marrage SSH) |

**Variables interpol√©es par Terraform :**

- `${hostname}` ‚Üí Nom de la VM
- `${ssh_public_key}` ‚Üí Cl√© publique SSH depuis `terraform.tfvars`

***

## üî∑ Comment √ßa fonctionne ?

**Cycle de vie cloud-init  :**[^2][^4]

1. **Proxmox injecte** le fichier `user-data` via le lecteur cloud-init (IDE2/SCSI)
2. **Premier boot** : cloud-init lit `/run/cloud-init/user-data`
3. **Ex√©cution s√©quentielle** :
    - √âtape 1 : Configuration r√©seau (IP statique)
    - √âtape 2 : Cr√©ation utilisateur `ansible`
    - √âtape 3 : Installation packages (`apt update && apt install`)
    - √âtape 4 : √âcriture fichiers (`/etc/ssh/sshd_config.d/...`)
    - √âtape 5 : Ex√©cution `runcmd` (systemctl enable qemu-guest-agent)
4. **Fin** : Cloud-init se d√©sactive (fichier t√©moin `/var/lib/cloud/instance/boot-finished`)

**Nota** : Cloud-init ne s'ex√©cute qu'**une seule fois** au premier boot.

***

## üî∑ Qemu-guest-agent : c'est quoi, √† quoi √ßa sert ?

**D√©finition  :**[^5][^4][^6]
D√©mon (daemon) install√© dans la VM qui permet la communication **h√¥te Proxmox ‚Üî VM invit√©e** via un canal virtio-serial.

**Utilisations principales :**


| Fonction | Explication |
| :-- | :-- |
| **Shutdown propre** | Arr√™t OS graceful au lieu d'ACPI brutal |
| **Freeze filesystem** | Snapshot coh√©rent (appel `fsfreeze` avant backup) |
| **R√©cup√©ration infos** | IP, hostname, processus, temps d'activit√© |
| **Synchronisation horaire** | Synchro horloge apr√®s snapshot/pause |
| **Ex√©cution commandes** | Lancement de scripts dans la VM depuis Proxmox |

**Sans qemu-guest-agent :**

- Backup incoh√©rent (fichiers ouverts corrompus)
- Arr√™t forc√© (√©quivalent "couper le courant")
- Proxmox ne conna√Æt pas l'IP interne de la VM

***

## üî∑ Appel API : POST /api2/json/nodes/{node}/qemu/{template_vmid}/clone

**Protocole utilis√©  :**[^1]

- **HTTPS** (port 8006) avec authentification par token API
- Format : `Authorization: PVEAPIToken=user@realm!token=SECRET`

**Exemple d'appel complet :**

```bash
curl -k -X POST \
  "https://10.250.250.4:8006/api2/json/nodes/pve4/qemu/9000/clone" \
  -H "Authorization: PVEAPIToken=ansible@pve!terraform=xxx-xxx-xxx" \
  -d "newid=123&name=tools-manager"
```

**R√©ponse :** JSON avec le VMID de la nouvelle VM clon√©e.

***

## üî∑ Snippets cloud-init : cr√©ation, d√©claration, cycle de vie

### √âtapes de cr√©ation du snippet[^2][^1]

**1. Cr√©er le datastore snippets sur Proxmox :**

```bash
pvesm set <datastore-id> --content snippets
```

**2. Uploader le fichier via SCP/SFTP :**

```bash
scp user-data.yaml root@proxmox:/var/lib/vz/snippets/user-data-vm123.yaml
```

**3. V√©rifier les permissions :**

```bash
chmod 644 /var/lib/vz/snippets/user-data-vm123.yaml
```


### D√©claration dans Terraform

**Via l'attribut `cicustom`  :**[^7][^1]

```hcl
resource "proxmox_virtual_environment_vm" "vm" {
  initialization {
    user_data_file_id = "local:snippets/user-data-vm123.yaml"
  }
}
```

**Ou directement dans la config VM via CLI :**

```bash
qm set 123 --cicustom "user=local:snippets/user-data-vm123.yaml"
```


### Cycle de vie

**√âtapes  :**[^2]

1. **Cr√©ation** : Snippet stock√© dans `/var/lib/vz/snippets/`
2. **Attachement** : Proxmox lie le snippet au lecteur cloud-init (IDE2)
3. **Injection** : Au boot, cloud-init lit le snippet via le lecteur virtuel
4. **Ex√©cution** : Cloud-init applique la configuration
5. **Archivage** : Snippet conserv√© dans `/var/lib/cloud/instance/` (logs)

**Nota :** Le snippet peut √™tre r√©utilis√© pour plusieurs VMs.

***

## üî∑ Best practices officielles : modifications de configuration

### Si je modifie une config machine (CPU/RAM/Disque)

**M√©thode Terraform  :**[^8][^7]

1. **Modifier `terraform.tfvars` :**
```hcl
nodes = {
  tools-manager = {
    cpu  = 4  # Avant: 2
    mem  = 8192  # Avant: 4096
    disk = 80  # Avant: 60
    # ...
  }
}
```

2. **V√©rifier l'impact :**
```bash
terraform plan
```

3. **Appliquer les modifications :**
```bash
terraform apply
```

**Comportement :**

- **CPU/RAM** : Modification √† chaud (hot-plug) si VM d√©marr√©e
- **Disque** : Extension uniquement (jamais de r√©duction)
- **Pas de recr√©ation** de la VM (modification in-place)

**Attention :** Proxmox ne permet pas de r√©duire la taille du disque.[^8]

***

### Si je modifie le r√©seau

**M√©thode Terraform  :**[^7]

1. **Modifier l'IP dans `terraform.tfvars` :**
```hcl
nodes = {
  tools-manager = {
    ip = "172.16.100.25"  # Avant: 172.16.100.20
  }
}
```

2. **Terraform d√©tectera le changement dans `initialization.ip_config` :**
```bash
terraform plan
# Output: ~ update in-place (changement IP)
```

3. **Appliquer :**
```bash
terraform apply
```

**Comportement :**

- Cloud-init est **r√©ex√©cut√©** au prochain red√©marrage
- **Red√©marrage manuel requis** pour appliquer la nouvelle IP :

```bash
qm reboot 123
```

**Alternative manuelle (sans red√©marrage) :**

```bash
# Dans la VM
sudo ip addr add 172.16.100.25/24 dev eth0
sudo ip route add default via 172.16.100.1
```


***

### Si je modifie cloud-init (user-data)

**M√©thode officielle  :**[^1][^7]

1. **Modifier le template `user-data.yaml.tftpl` :**
```yaml
packages:
  - qemu-guest-agent
  - python3
  - vim  # Nouveau package
```

2. **Terraform r√©g√©n√®re le snippet :**
```bash
terraform plan
# Output: ~ cicustom changed (snippet mis √† jour)
```

3. **Appliquer :**
```bash
terraform apply
```

**Probl√®me :** Cloud-init ne s'ex√©cute qu'**une seule fois**.[^3][^2]

**Solutions  :**[^3]

**Option A : Forcer la r√©ex√©cution de cloud-init**

```bash
# Dans la VM
sudo cloud-init clean
sudo cloud-init init
sudo reboot
```

**Option B : Recr√©er la VM (m√©thode idempotente)**

```bash
terraform taint proxmox_virtual_environment_vm.vm["tools-manager"]
terraform apply
```

**Option C : Utiliser Ansible pour les modifications post-d√©ploiement**

```bash
# Ansible applique les changements sans recr√©er la VM
ansible-playbook playbooks/update-config.yml
```

**Best practice  :**[^7]

- Cloud-init pour le **bootstrap initial** uniquement
- Ansible pour la **gestion de configuration continue**

***

## üìä R√©capitulatif des m√©thodes

| Modification | Outil | Red√©marrage requis | M√©thode |
| :-- | :-- | :-- | :-- |
| CPU/RAM | Terraform | Non (hot-plug) | `terraform apply` |
| Disque (agrandir) | Terraform | Non | `terraform apply` |
| IP statique | Terraform | Oui | `terraform apply` + `qm reboot` |
| Cloud-init (nouveau package) | Ansible | Non | Playbook Ansible |
| Cloud-init (utilisateur) | Terraform + taint | Oui | `terraform taint` + `apply` |


***

Vous avez maintenant une vision compl√®te du workflow DevSecOps avec cloud-init. Des questions sur un point particulier ?
<span style="display:none">[^10][^11][^12][^13][^14][^15][^9]</span>

<div align="center">‚ÅÇ</div>

[^1]: https://pve.proxmox.com/wiki/Cloud-Init_Support

[^2]: https://www.virtualizationhowto.com/2025/10/proxmox-cloud-init-made-easy-automating-vm-provisioning-like-the-cloud/

[^3]: https://pve.proxmox.com/wiki/Cloud-Init_FAQ

[^4]: https://pve.proxmox.com/mediawiki/index.php?title=Qemu-guest-agent

[^5]: https://tuxcare.com/blog/qemu-agent-proxmox/

[^6]: https://pve.proxmox.com/wiki/Qemu-guest-agent

[^7]: https://www.reddit.com/r/Terraform/comments/1l2crms/using_terraform_to_provision_proxmox_vms_what_if/

[^8]: https://stackoverflow.com/questions/70200143/how-to-handle-resources-of-existing-vm-inside-proxmox-using-terraform

[^9]: https://www.reddit.com/r/Proxmox/comments/172hz58/please_elaborate_on_cloudinit/

[^10]: https://www.youtube.com/watch?v=1Ec0Vg5be4s

[^11]: https://www.youtube.com/watch?v=E8heMmnS9Wc

[^12]: https://www.youtube.com/watch?v=3I3C4RfluEg

[^13]: https://www.xda-developers.com/use-terraform-with-proxmox/

[^14]: https://www.thomas-krenn.com/en/wiki/Cloud_Init_Templates_in_Proxmox_VE_-_Quickstart

[^15]: https://spacelift.io/blog/terraform-proxmox-provider



