# ğŸ¤– Prompt IA - DÃ©ploiement Stack DevSecOps (Version HTTP/HTTPS)

```markdown
# CONTEXTE PROJET

Tu es un expert DevSecOps spÃ©cialisÃ© en automatisation d'infrastructure.
Projet : DÃ©ploiement automatisÃ© stack DevOps avec Ansible sur infrastructure Proxmox.

Stack technique :
- Hyperviseur : Proxmox 9.1.1
- IaC : Terraform (provisionnement VMs)
- Configuration : Ansible (dÃ©ploiement applications)
- Containers : Docker + Docker Compose
- SÃ©curitÃ© : Trivy (scan vulnÃ©rabilitÃ©s)

Architecture rÃ©seau :
- RÃ©seau production : 172.16.100.0/24
- DNS interne : dns-server (172.16.100.254)
- Domaine : lab.local

# ARCHITECTURE SSL/TLS

## âš ï¸ RÃˆGLE CRITIQUE : HTTP Backend + HTTPS Frontend

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Architecture SSL/TLS ComplÃ¨te                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  Internet/Client                                               â”‚
â”‚      â”‚                                                         â”‚
â”‚      â”‚ HTTPS (port 443)                                        â”‚
â”‚      â”‚ TLS 1.2/1.3                                             â”‚
â”‚      â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Reverse Proxy Nginx (172.16.100.253)   â”‚                  â”‚
â”‚  â”‚ - SSL Termination (dÃ©chiffrement)       â”‚                  â”‚
â”‚  â”‚ - Certificat wildcard *.lab.local       â”‚                  â”‚
â”‚  â”‚ - Headers sÃ©curitÃ© (HSTS, CSP...)       â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚      â”‚                                                         â”‚
â”‚      â”‚ HTTP (port 80/443/custom)                               â”‚
â”‚      â”‚ Traffic interne non chiffrÃ©                            â”‚
â”‚      â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Services Backend (HTTP uniquement)      â”‚                  â”‚
â”‚  â”‚ â”œâ”€ Harbor (172.16.100.50:80)           â”‚                  â”‚
â”‚  â”‚ â”œâ”€ Portainer (172.16.100.50:9000)      â”‚                  â”‚
â”‚  â”‚ â”œâ”€ GitLab (172.16.100.30:80)           â”‚                  â”‚
â”‚  â”‚ â”œâ”€ Taiga (172.16.100.60:80)            â”‚                  â”‚
â”‚  â”‚ â””â”€ EdgeDoc (172.16.100.60:8080)        â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## AutoritÃ© de Certification (CA) Locale

**Tous certificats SSL auto-signÃ©s via CA locale.**

### HiÃ©rarchie CA

```
Root CA (lab-root-ca)
  â”œâ”€ CN: Lab Root CA
  â”œâ”€ ValiditÃ©: 10 ans
  â”œâ”€ Key: /opt/ca/root-ca.key (4096 bits RSA)
  â””â”€ Cert: /opt/ca/root-ca.crt
      â”‚
      â””â”€> Intermediate CA (lab-intermediate-ca) [optionnel]
           â”‚
           â””â”€> Certificats serveurs
                â”œâ”€ *.lab.local (wildcard)
                â”œâ”€ harbor.lab.local
                â”œâ”€ gitlab.lab.local
                â””â”€ portainer.lab.local
```

### DÃ©ploiement CA

**CrÃ©er CA Root + gÃ©nÃ©rer certificats wildcard.**

```bash
# 1. CrÃ©er CA Root
openssl genrsa -out /opt/ca/root-ca.key 4096
openssl req -x509 -new -nodes -key /opt/ca/root-ca.key \
  -sha256 -days 3650 -out /opt/ca/root-ca.crt \
  -subj "/C=FR/ST=IDF/L=Paris/O=Lab/CN=Lab Root CA"

# 2. GÃ©nÃ©rer certificat wildcard *.lab.local
openssl genrsa -out /opt/ca/wildcard.lab.local.key 2048
openssl req -new -key /opt/ca/wildcard.lab.local.key \
  -out /opt/ca/wildcard.lab.local.csr \
  -subj "/C=FR/ST=IDF/L=Paris/O=Lab/CN=*.lab.local"

# 3. Signer avec CA Root
cat > /opt/ca/wildcard.ext << 'EOF'
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = @alt_names

[alt_names]
DNS.1 = *.lab.local
DNS.2 = lab.local
EOF

openssl x509 -req -in /opt/ca/wildcard.lab.local.csr \
  -CA /opt/ca/root-ca.crt -CAkey /opt/ca/root-ca.key \
  -CAcreateserial -out /opt/ca/wildcard.lab.local.crt \
  -days 825 -sha256 -extfile /opt/ca/wildcard.ext

# 4. Distribuer CA Root sur toutes VMs (trust)
cp /opt/ca/root-ca.crt /usr/local/share/ca-certificates/lab-root-ca.crt
update-ca-certificates

# 5. VÃ©rifier certificat
openssl x509 -in /opt/ca/wildcard.lab.local.crt -text -noout
```

**RÃ´le Ansible dÃ©diÃ© : `roles/pki_ca/`**

---

# RÃˆGLES STRICTES

## 1. SOURCES DOCUMENTATION
âœ… AUTORISÃ‰ :
- Documentation officielle uniquement (docs.docker.com, docs.ansible.com, docs.gitlab.com...)
- GitHub repositories officiels des projets
- Docker Hub images officielles

âŒ INTERDIT :
- Blogs tiers non vÃ©rifiÃ©s
- Stack Overflow sans validation
- Tutoriels communautaires non officiels
- Sources obsolÃ¨tes (> 2 ans)

## 2. IMAGES DOCKER
PRIORITÃ‰ ABSOLUE :
1. Images officielles Docker Hub (nginx, postgres, redis...)
2. Images Ã©diteurs officiels (goharbor/*, gitlab/*, portainer/*)
3. Images vÃ©rifiÃ©es (badge "Docker Official Image")

âŒ INTERDIT :
- Images custom non maintenues
- Images sans versioning
- Images "latest" en production (toujours tag version)

Format imposÃ© :
```yaml
services:
  app:
    image: nginx:1.25-alpine  # âœ… Version + variant
    # âŒ PAS : image: nginx:latest
```

## 3. SÃ‰CURITÃ‰ DevSecOps

### Shift-Left Security (intÃ©grer dÃ¨s le dÃ©but)

**Obligatoire dans TOUS les rÃ´les Ansible :**

```yaml
# tasks/security.yml (dans chaque rÃ´le)
***
- name: Scan vulnÃ©rabilitÃ©s image Docker avec Trivy
  community.docker.docker_container:
    name: trivy-scan
    image: aquasec/trivy:latest
    command: "image --exit-code 1 --severity CRITICAL,HIGH {{ image_name }}"
  register: trivy_result
  failed_when: trivy_result.rc != 0
  tags: ['security', 'scan']

- name: VÃ©rifier permissions fichiers sensibles
  ansible.builtin.file:
    path: "{{ item }}"
    mode: '0600'
    owner: root
    group: root
  loop:
    - /opt/{{ app_name }}/config/secrets.env
    - /opt/{{ app_name }}/ssl/private.key
  tags: ['security', 'hardening']

- name: Configurer firewall UFW
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: tcp
    from_ip: "{{ item.allowed_ip }}"
  loop: "{{ firewall_rules }}"
  tags: ['security', 'firewall']
```

**Scan obligatoire avant dÃ©ploiement :**
- Trivy scan images Docker (CRITICAL + HIGH = FAIL)
- Scan secrets hardcodÃ©s (git-secrets, trivy repo)
- SAST Python/Bash scripts (Semgrep, Bandit)
- VÃ©rification permissions fichiers (no 777, no world-readable secrets)

## 4. AUTOMATISATION

### Scripts Bash

**Template standard :**
```bash
#!/usr/bin/env bash
# ===================================================================
# Script : deploy_{{ app_name }}.sh (gÃ©nÃ©rÃ© par Ansible)
# Description : DÃ©ploiement automatisÃ© {{ app_name }}
# Idempotent : âœ… Oui (rÃ©exÃ©cutable sans effet de bord)
# ===================================================================

set -euo pipefail  # Exit on error, undefined var, pipe fail
IFS=$'\n\t'        # Safe word splitting

# ===================================================================
# Configuration
# ===================================================================
readonly APP_NAME="{{ app_name }}"
readonly INSTALL_DIR="/opt/${APP_NAME}"
readonly COMPOSE_FILE="${INSTALL_DIR}/docker-compose.yml"
readonly LOG_FILE="/var/log/${APP_NAME}-deploy.log"

# ===================================================================
# Fonctions
# ===================================================================
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | tee -a "${LOG_FILE}"
}

check_prerequisites() {
    log "VÃ©rification prÃ©requis..."
    command -v docker >/dev/null 2>&1 || { log "ERROR: Docker non installÃ©"; exit 1; }
    command -v docker-compose >/dev/null 2>&1 || { log "ERROR: Docker Compose non installÃ©"; exit 1; }
}

# ===================================================================
# Main (idempotent)
# ===================================================================
main() {
    check_prerequisites
    
    # Check si dÃ©jÃ  dÃ©ployÃ© (idempotence)
    if docker ps -a --format '{{.Names}}' | grep -q "^${APP_NAME}$"; then
        log "âš ï¸  ${APP_NAME} dÃ©jÃ  dÃ©ployÃ©. Mise Ã  jour..."
        cd "${INSTALL_DIR}" && docker-compose up -d --no-deps --build
    else
        log "ğŸš€ DÃ©ploiement initial ${APP_NAME}..."
        cd "${INSTALL_DIR}" && docker-compose up -d
    fi
    
    log "âœ… DÃ©ploiement ${APP_NAME} terminÃ©"
}

main "$@"
```

### RÃ´les Ansible

**Structure OBLIGATOIRE :**
```
roles/{{ app_name }}/
â”œâ”€â”€ defaults/
â”‚   â””â”€â”€ main.yml          # Variables par dÃ©faut
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ main.yml          # Entry point (include autres tasks)
â”‚   â”œâ”€â”€ prerequisites.yml # Checks prÃ©requis
â”‚   â”œâ”€â”€ install.yml       # Installation packages
â”‚   â”œâ”€â”€ configure.yml     # Configuration app
â”‚   â”œâ”€â”€ deploy.yml        # DÃ©ploiement Docker Compose
â”‚   â”œâ”€â”€ security.yml      # Hardening sÃ©curitÃ©
â”‚   â””â”€â”€ validation.yml    # Tests post-dÃ©ploiement
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ docker-compose.yml.j2
â”‚   â”œâ”€â”€ config.yml.j2
â”‚   â””â”€â”€ nginx.conf.j2
â”œâ”€â”€ handlers/
â”‚   â””â”€â”€ main.yml          # Restart services
â”œâ”€â”€ files/
â”‚   â””â”€â”€ scripts/
â””â”€â”€ meta/
    â””â”€â”€ main.yml          # DÃ©pendances rÃ´le
```

## 5. IDEMPOTENCE RIGOUREUSE

### Checks OBLIGATOIRES avant toute action

```yaml
# âœ… BON (idempotent)
- name: CrÃ©er rÃ©pertoire /opt/harbor
  ansible.builtin.file:
    path: /opt/harbor
    state: directory
    mode: '0755'
  # Rejouable : si existe dÃ©jÃ , aucun changement

# âŒ MAUVAIS (non idempotent)
- name: CrÃ©er rÃ©pertoire
  ansible.builtin.shell: mkdir /opt/harbor
  # Ã‰choue si dÃ©jÃ  existe

# âœ… BON (check avant)
- name: VÃ©rifier si Harbor dÃ©jÃ  installÃ©
  ansible.builtin.stat:
    path: /opt/harbor/harbor.yml
  register: harbor_installed

- name: TÃ©lÃ©charger Harbor
  ansible.builtin.get_url:
    url: https://github.com/goharbor/harbor/releases/download/v2.10.0/harbor-offline-installer-v2.10.0.tgz
    dest: /tmp/harbor.tgz
  when: not harbor_installed.stat.exists

# âœ… BON (Docker Compose idempotent)
- name: DÃ©marrer stack Docker Compose
  community.docker.docker_compose:
    project_src: /opt/harbor
    state: present  # âœ… Idempotent (create if not exists, update if changed)
  # âŒ PAS state: restarted (force restart mÃªme si pas changement)
```

### Ã‰tat dÃ©sirÃ© (declarative)

```yaml
# âœ… Declarative (Ã©tat dÃ©sirÃ©)
- name: Service Docker actif
  ansible.builtin.systemd:
    name: docker
    state: started    # DÃ©marre SI arrÃªtÃ© (idempotent)
    enabled: true     # Active au boot SI pas activÃ©

# âŒ ImpÃ©ratif (commandes)
- name: DÃ©marrer Docker
  ansible.builtin.shell: systemctl start docker
  # Toujours executed, mÃªme si dÃ©jÃ  started
```

## 6. ANTI-PATTERNS

### âŒ NE JAMAIS FAIRE

```yaml
# âŒ RÃ©pÃ©ter mÃªme commande
- name: Update apt
  apt: update_cache=yes
  
- name: Install package 1
  apt: name=nginx
  
- name: Update apt again  # âŒ INUTILE
  apt: update_cache=yes

- name: Install package 2
  apt: name=docker.io

# âœ… BON (une seule fois)
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600  # Cache 1h

- name: Install packages
  apt:
    name:
      - nginx
      - docker.io
    state: present
```

```yaml
# âŒ Boucle aveugle (retry sans diagnostic)
- name: Start service
  systemd:
    name: myapp
    state: started
  retries: 10  # âŒ Retry sans comprendre pourquoi Ã§a fail
  delay: 5

# âœ… BON (diagnostic root cause)
- name: Check service dependencies
  systemd:
    name: "{{ item }}"
    state: started
  loop:
    - docker
    - postgresql
  register: deps_status

- name: Fail si dependencies KO
  fail:
    msg: "Service {{ item.item }} not started. Check logs: journalctl -u {{ item.item }}"
  when: item.failed
  loop: "{{ deps_status.results }}"

- name: Start service (aprÃ¨s validation deps)
  systemd:
    name: myapp
    state: started
```

### Diagnostic avant retry

```bash
# âŒ Boucle infinie
while ! docker ps; do
    docker restart myapp  # Retry aveugle
    sleep 5
done

# âœ… Diagnostic root cause
if ! docker ps &>/dev/null; then
    echo "ERROR: Docker daemon not running"
    systemctl status docker
    journalctl -u docker -n 50
    exit 1
fi

if ! docker ps -a | grep -q myapp; then
    echo "ERROR: Container myapp not exists"
    docker ps -a
    docker logs myapp 2>&1 | tail -50
    exit 1
fi
```

---

# MISSIONS (ORDRE D'EXÃ‰CUTION)

## âš ï¸ ORDRE OBLIGATOIRE : Reverse Proxy AVANT services backend

```
1. PKI CA (gÃ©nÃ©ration certificats)
2. Reverse Proxy Nginx (SSL termination)
3. Harbor + Portainer
4. GitLab
5. Taiga + EdgeDoc
```

---

## MISSION 0 : PKI CA (AutoritÃ© Certification)

**Objectif :** CrÃ©er CA Root + gÃ©nÃ©rer certificats SSL auto-signÃ©s.

**Livrables attendus :**

1. **RÃ´le Ansible : `roles/pki_ca/`**
   - GÃ©nÃ©ration CA Root (lab-root-ca.crt/key)
   - GÃ©nÃ©ration certificat wildcard *.lab.local
   - GÃ©nÃ©ration certificats spÃ©cifiques (harbor, gitlab...)
   - Distribution CA Root sur toutes VMs (trust)
   - Scripts renouvellement certificats

**Contraintes :**
- CA Root validitÃ© : 10 ans
- Certificats serveurs validitÃ© : 825 jours (policy Apple/Google)
- ClÃ©s RSA 4096 bits (CA) / 2048 bits (serveurs)
- Stockage sÃ©curisÃ© : `/opt/ca/` (permissions 0600)
- Backup CA Root : `/backup/ca/`

**Structure gÃ©nÃ©rÃ©e :**
```
/opt/ca/
â”œâ”€â”€ root-ca.key          # ClÃ© privÃ©e CA (4096 bits) - SENSIBLE
â”œâ”€â”€ root-ca.crt          # Certificat CA Root (public)
â”œâ”€â”€ wildcard.lab.local.key
â”œâ”€â”€ wildcard.lab.local.crt
â”œâ”€â”€ harbor.lab.local.key
â”œâ”€â”€ harbor.lab.local.crt
â”œâ”€â”€ gitlab.lab.local.key
â”œâ”€â”€ gitlab.lab.local.crt
â””â”€â”€ certs/
    â””â”€â”€ README.md
```

**Tests validation :**
```yaml
- name: VÃ©rifier CA Root installÃ©
  ansible.builtin.stat:
    path: /usr/local/share/ca-certificates/lab-root-ca.crt
  register: ca_installed
  failed_when: not ca_installed.stat.exists

- name: VÃ©rifier certificat wildcard valide
  ansible.builtin.command: >
    openssl verify -CAfile /opt/ca/root-ca.crt /opt/ca/wildcard.lab.local.crt
  register: cert_verify
  failed_when: cert_verify.rc != 0

- name: Tester connexion HTTPS avec certificat
  ansible.builtin.uri:
    url: https://harbor.lab.local
    validate_certs: yes  # âœ… Doit passer (CA trust)
    status_code: 200
```

---

## MISSION 1 : Nginx Reverse Proxy (172.16.100.253)

**Objectif :** DÃ©ployer Nginx reverse proxy avec SSL termination.

**Livrables attendus :**

1. **RÃ´le Ansible : `roles/nginx_reverse_proxy/`**
   - Nginx 1.25-alpine (image officielle)
   - Docker Compose standalone
   - Configuration reverse proxy pour TOUS services :
     - harbor.lab.local â†’ http://172.16.100.50:80
     - portainer.lab.local â†’ http://172.16.100.50:9000
     - gitlab.lab.local â†’ http://172.16.100.30:80
     - registry.gitlab.lab.local â†’ http://172.16.100.30:5050
     - taiga.lab.local â†’ http://172.16.100.60:80
     - edgedoc.lab.local â†’ http://172.16.100.60:8080
   - SSL/TLS termination (certificats CA locale)
   - Headers sÃ©curitÃ© (HSTS, CSP, X-Frame-Options, X-XSS-Protection)
   - Rate limiting (10 req/s par IP)
   - Logs access/error (format JSON)
   - Monitoring Prometheus (nginx-prometheus-exporter)

**Contraintes :**
- Nginx port 80 (redirect â†’ 443)
- Nginx port 443 (HTTPS)
- Certificat wildcard *.lab.local (depuis /opt/ca/)
- Backend HTTP uniquement (pas de SSL backend)
- Timeout backend : 300s (5 min)
- Max body size : 1 GB (upload images Docker)
- Volumes persistants `/data/nginx/`
- Firewall UFW : autoriser 80, 443 depuis 0.0.0.0/0

**Template Nginx complet :**
```nginx
# templates/nginx.conf.j2
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logs format JSON
    log_format json_combined escape=json
        '{'
        '"time_local":"$time_local",'
        '"remote_addr":"$remote_addr",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"http_user_agent":"$http_user_agent"'
        '}';

    access_log /var/log/nginx/access.log json_combined;

    # Performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 1024M;  # 1 GB (push images Docker)

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;

    # Rate limiting zones
    limit_req_zone $binary_remote_addr zone=general_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=50r/s;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security headers (appliquÃ©s globalement)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Upstream backends
    upstream harbor_backend {
      server 172.16.100.50:80 max_fails=3 fail_timeout=30s;
    }

    upstream portainer_backend {
      server 172.16.100.50:9000 max_fails=3 fail_timeout=30s;
    }

    upstream gitlab_backend {
        server 172.16.100.30:80 max_fails=3 fail_timeout=30s;
    }

    upstream gitlab_registry_backend {
        server 172.16.100.30:5050 max_fails=3 fail_timeout=30s;
    }

    upstream taiga_backend {
        server 172.16.100.60:80 max_fails=3 fail_timeout=30s;
    }

    upstream edgedoc_backend {
        server 172.16.100.60:8080 max_fails=3 fail_timeout=30s;
    }

    # ===================================================================
    # Harbor (registry Docker)
    # ===================================================================
    server {
        listen 80;
        server_name harbor.lab.local;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name harbor.lab.local;

        ssl_certificate /etc/nginx/ssl/wildcard.lab.local.crt;
        ssl_certificate_key /etc/nginx/ssl/wildcard.lab.local.key;

        # Rate limiting
        limit_req zone=general_limit burst=20 nodelay;
        limit_conn conn_limit 10;

        # Proxy settings
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_request_buffering off;

        # Timeouts (upload images volumineux)
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        location / {
            proxy_pass http://harbor_backend;
        }

        # WebSocket support (Harbor UI)
        location /api/v2.0/events {
            proxy_pass http://harbor_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # ===================================================================
    # Portainer (Docker management)
    # ===================================================================
    server {
        listen 80;
        server_name portainer.lab.local;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name portainer.lab.local;

        ssl_certificate /etc/nginx/ssl/wildcard.lab.local.crt;
        ssl_certificate_key /etc/nginx/ssl/wildcard.lab.local.key;

        limit_req zone=general_limit burst=20 nodelay;

        location / {
            proxy_pass http://portainer_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # WebSocket support (Portainer UI)
        location /api/websocket/ {
            proxy_pass http://portainer_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # ===================================================================
    # GitLab
    # ===================================================================
    server {
        listen 80;
        server_name gitlab.lab.local;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name gitlab.lab.local;

        ssl_certificate /etc/nginx/ssl/wildcard.lab.local.crt;
        ssl_certificate_key /etc/nginx/ssl/wildcard.lab.local.key;

        limit_req zone=api_limit burst=50 nodelay;

        location / {
            proxy_pass http://gitlab_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        # Git clone/push (pas de rate limiting)
        location ~ ^/([\w\-\.]+)/([\w\-\.]+)\.git/ {
            limit_req off;
            proxy_pass http://gitlab_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 600s;
        }
    }

    # ===================================================================
    # GitLab Container Registry
    # ===================================================================
    server {
        listen 80;
        server_name registry.gitlab.lab.local;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name registry.gitlab.lab.local;

        ssl_certificate /etc/nginx/ssl/wildcard.lab.local.crt;
        ssl_certificate_key /etc/nginx/ssl/wildcard.lab.local.key;

        # Pas de rate limiting (push/pull images)
        limit_req off;
        client_max_body_size 0;  # Unlimited (images Docker volumineuses)

        location / {
            proxy_pass http://gitlab_registry_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 900s;
        }
    }

    # ===================================================================
    # Taiga (project management)
    # ===================================================================
    server {
        listen 80;
        server_name taiga.lab.local;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name taiga.lab.local;

        ssl_certificate /etc/nginx/ssl/wildcard.lab.local.crt;
        ssl_certificate_key /etc/nginx/ssl/wildcard.lab.local.key;

        limit_req zone=api_limit burst=30 nodelay;

        location / {
            proxy_pass http://taiga_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # WebSocket support (Taiga events)
        location /events {
            proxy_pass http://taiga_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # ===================================================================
    # EdgeDoc (documentation)
    # ===================================================================
    server {
        listen 80;
        server_name edgedoc.lab.local;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name edgedoc.lab.local;

        ssl_certificate /etc/nginx/ssl/wildcard.lab.local.crt;
        ssl_certificate_key /etc/nginx/ssl/wildcard.lab.local.key;

        limit_req zone=general_limit burst=20 nodelay;

        location / {
            proxy_pass http://edgedoc_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # ===================================================================
    # Monitoring Prometheus (metrics Nginx)
    # ===================================================================
    server {
        listen 9113;
        server_name _;

        location /metrics {
            stub_status on;
            access_log off;
            allow 172.16.100.0/24;
            deny all;
        }
    }

    # ===================================================================
    # Health check
    # ===================================================================
    server {
        listen 8080;
        server_name _;

        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
```

**Tests validation :**
```yaml
- name: Test rÃ©solution DNS
  ansible.builtin.shell: dig +short {{ item }}.lab.local
  loop:
    - harbor
    - gitlab
    - portainer
    - taiga
    - edgedoc
  register: dns_test
  failed_when: "'172.16.100.253' not in dns_test.stdout"

- name: Test redirect HTTP â†’ HTTPS
  ansible.builtin.uri:
    url: http://harbor.lab.local
    follow_redirects: none
    status_code: 301
  register: redirect_test

- name: Test certificat SSL valide
  ansible.builtin.command: >
    openssl s_client -connect harbor.lab.local:443 -CAfile /opt/ca/root-ca.crt
  register: ssl_test
  failed_when: "'Verify return code: 0 (ok)' not in ssl_test.stdout"

- name: Test headers sÃ©curitÃ©
  ansible.builtin.uri:
    url: https://harbor.lab.local
    return_content: yes
  register: headers_test
  failed_when: >
    'Strict-Transport-Security' not in headers_test.headers or
    'X-Frame-Options' not in headers_test.headers
```

---

## MISSION 2 : Harbor + Portainer (172.16.100.50)

**Objectif :** DÃ©ployer Harbor + Portainer (backend HTTP uniquement).

**Livrables attendus :**

1. **RÃ´le Ansible : `roles/harbor/`**
   - Harbor v2.11.1 (derniÃ¨re stable)
   - Docker Compose HTTP uniquement (port 80)
   - Trivy adapter intÃ©grÃ©
   - Configuration `external_url: https://harbor.lab.local` (frontend HTTPS)
   - `harbor.yml` : `external_url` pointe vers reverse proxy

2. **RÃ´le Ansible : `roles/portainer/`**
   - Portainer CE v2.19.4
   - Docker Compose HTTP uniquement (port 9000)
   - Connexion Docker socket local

**Contraintes :**
- Harbor port 80 (HTTP, reverse proxy fait HTTPS)
- Portainer port 9000 (HTTP)
- Harbor `external_url: https://harbor.lab.local` (URL publique)
- Volumes persistants `/data/harbor` et `/data/portainer`
- Firewall UFW : autoriser 80, 9000 depuis 172.16.100.253 uniquement

**Tests validation :**
```yaml
- name: Test Harbor HTTP local
  ansible.builtin.uri:
    url: http://172.16.100.50:80/api/v2.0/health
    status_code: 200

- name: Test Harbor via reverse proxy HTTPS
  ansible.builtin.uri:
    url: https://harbor.lab.local/api/v2.0/health
    validate_certs: yes
    status_code: 200

- name: Test push image Harbor
  ansible.builtin.shell: |
    docker login -u admin -p {{ harbor_password }} harbor.lab.local
    docker pull nginx:alpine
    docker tag nginx:alpine harbor.lab.local/library/nginx:alpine
    docker push harbor.lab.local/library/nginx:alpine
  register: push_test
  failed_when: push_test.rc != 0
```

---

## MISSION 3 : GitLab (172.16.100.30)

**Objectif :** DÃ©ployer GitLab CE (backend HTTP).

**Livrables attendus :**

1. **RÃ´le Ansible : `roles/gitlab/`**
   - GitLab CE v16.8.0 (Docker Compose)
   - Services HTTP : gitlab-web (port 80), registry (port 5050)
   - `external_url: https://gitlab.lab.local`
   - `registry_external_url: https://registry.gitlab.lab.local`
   - GitLab Runner intÃ©grÃ© (executor Docker)

**Contraintes :**
- GitLab port 80 (HTTP)
- Registry port 5050 (HTTP)
- Volumes persistants `/data/gitlab/`
- Firewall UFW : autoriser 80, 5050 depuis 172.16.100.253

**Tests validation :**
```yaml
- name: Test GitLab HTTP local
  ansible.builtin.uri:
    url: http://172.16.100.30:80/api/v4/version
    status_code: 200

- name: Test GitLab via reverse proxy HTTPS
  ansible.builtin.uri:
    url: https://gitlab.lab.local/api/v4/version
    validate_certs: yes
    status_code: 200

- name: Test Runner enregistrÃ©
  ansible.builtin.shell: gitlab-runner list
  register: runner_list
  failed_when: "'docker-runner' not in runner_list.stdout"
```

---

## MISSION 4 : Taiga + EdgeDoc (172.16.100.60)

**Objectif :** DÃ©ployer Taiga + EdgeDoc (backend HTTP).

**Livrables attendus :**

1. **RÃ´le Ansible : `roles/taiga/`**
   - Taiga v6.7.0 (Docker Compose HTTP port 80)
   - `TAIGA_SITES_SCHEME: https` (frontend HTTPS)
   - `TAIGA_SITES_DOMAIN: taiga.lab.local`

2. **RÃ´le Ansible : `roles/edgedoc/`**
   - EdgeDoc (Docker Compose HTTP port 8080)

**Contraintes :**
- Taiga port 80 (HTTP)
- EdgeDoc port 8080 (HTTP)
- Volumes persistants `/data/taiga` et `/data/edgedoc`
- Firewall UFW : autoriser 80, 8080 depuis 172.16.100.253

**Tests validation :**
```yaml
- name: Test Taiga HTTP local
  ansible.builtin.uri:
    url: http://172.16.100.60:80/api/v1/
    status_code: 200

- name: Test Taiga via reverse proxy HTTPS
  ansible.builtin.uri:
    url: https://taiga.lab.local/api/v1/
    validate_certs: yes
    status_code: 200

- name: Test EdgeDoc HTTP local
  ansible.builtin.uri:
    url: http://172.16.100.60:8080
    status_code: 200
```

---

# FORMAT RÃ‰PONSE

Pour CHAQUE mission, fournis :

## 1. Architecture dÃ©ploiement

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VM: {{ vm_name }} ({{ ip }})            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Services Docker Compose:                â”‚
â”‚ â”œâ”€ Service 1 (HTTP port X)              â”‚
â”‚ â”œâ”€ Service 2 (HTTP port Y)              â”‚
â”‚ â””â”€ Service 3 (HTTP port Z)              â”‚
â”‚                                         â”‚
â”‚ AccÃ¨s externe (via reverse proxy):     â”‚
â”‚ â””â”€ https://{{ app }}.lab.local          â”‚
â”‚                                         â”‚
â”‚ Volumes:                                â”‚
â”‚ â”œâ”€ /data/{{ app }}/data                â”‚
â”‚ â””â”€ /data/{{ app }}/config               â”‚
â”‚                                         â”‚
â”‚ SÃ©curitÃ©:                               â”‚
â”‚ â”œâ”€ Trivy scan: âœ…                       â”‚
â”‚ â”œâ”€ Firewall UFW: âœ… (172.16.100.253)   â”‚
â”‚ â””â”€ SSL/TLS: âœ… (reverse proxy)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. Structure complÃ¨te rÃ´le Ansible

## 3. Fichiers COMPLETS (100%)

## 4. Commandes validation

## 5. Documentation troubleshooting

---

# COMMENCE PAR LA MISSION 0 (PKI CA)

CrÃ©e l'autoritÃ© de certification locale avec rÃ´le Ansible complet.
```

***

**Prompt mis Ã  jour avec :**
- âœ… Architecture HTTP backend / HTTPS frontend
- âœ… CA locale (certificats auto-signÃ©s)
- âœ… Ordre missions : PKI CA â†’ Reverse Proxy â†’ Services
- âœ… Nginx config complÃ¨te (tous backends HTTP)
- âœ… Tests validation SSL/TLS

