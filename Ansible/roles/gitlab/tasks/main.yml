---
# -----------------------------------------------------------------------------
# Rôle: gitlab
# But: Installer Docker, déployer GitLab CE + GitLab Runner via Compose,
#      puis attendre que GitLab soit réellement disponible VIA le reverse-proxy.
# Contrainte: exécution en root via become: true.
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# 0) Variables attendues (SSOT)
# - gitlab_fqdn: FQDN public GitLab (ex: git-lab.lab.local)
# - gitlab_scheme: https
# - gitlab_healthcheck_path: /help (200) ou / (302)
# - gitlab_validate_certs: false si certificat auto-signé
# - gitlab_proxy_port: 443 (port d'entrée reverse-proxy)
# -----------------------------------------------------------------------------
- name: Vérifier variables essentielles (SSOT GitLab)
  ansible.builtin.assert:
    that:
      - gitlab_fqdn is defined
      - gitlab_scheme is defined
      - gitlab_healthcheck_path is defined
  fail_msg: >
    Les variables SSOT suivantes doivent être définies :
    - gitlab_fqdn
    - gitlab_scheme
    - gitlab_healthcheck_path

  become: true

# -----------------------------------------------------------------------------
# 1) Prérequis système: installation des paquets Docker.
# - docker.io : moteur Docker (daemon)
# - docker-compose : fourni par Debian (commande compose/compat)
# -----------------------------------------------------------------------------
- name: Prérequis Docker
  ansible.builtin.package:
    name:
      - docker.io
      - docker-compose  # Paquet Debian ; l'exécution réelle est pilotée par community.docker.docker_compose_v2
    state: present
  become: true

# -----------------------------------------------------------------------------
# 2) Service Docker: démarrer et activer au boot.
# -----------------------------------------------------------------------------
- name: Service Docker actif
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true
  become: true

# -----------------------------------------------------------------------------
# 3) Volumes persistants GitLab.
# -----------------------------------------------------------------------------
- name: Créer répertoires volumes
  ansible.builtin.file:
    path: "/srv/gitlab/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - config
    - logs
    - data
    - runner
  become: true

- name: Créer répertoires volumes
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ gitlab_config_dir }}"
    - "{{ gitlab_logs_dir }}"
    - "{{ gitlab_data_dir }}"
    - "{{ gitlab_runner_dir }}"
    - "{{ gitlab_runner_cache_dir }}"

# -----------------------------------------------------------------------------
# 4) Déploiement du docker-compose.yml.
# -----------------------------------------------------------------------------
- name: Déployer docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /srv/gitlab/docker-compose.yml
    mode: '0644'
  notify: restart gitlab
  become: true

# -----------------------------------------------------------------------------
# 5) Configuration GitLab Runner.
# NOTE: vous utilisez /srv/gitlab-runner ici ; à vérifier si vous vouliez /srv/gitlab/runner.
# Je ne change pas sans nécessité, mais gardez une SSOT de chemins.
# -----------------------------------------------------------------------------
- name: Déployer runner config
  ansible.builtin.template:
    src: runner-config.toml.j2
    dest: "{{ gitlab_runner_config_dir }}/config.toml"
    mode: '0600'


# -----------------------------------------------------------------------------
# 6) Lancer / converger la stack GitLab via le module community.docker.
# -----------------------------------------------------------------------------
- name: Lancer GitLab (Compose piloté par Ansible)
  community.docker.docker_compose_v2:
    project_src: /srv/gitlab
    state: present
    files:
      - docker-compose.yml
  become: true

# -----------------------------------------------------------------------------
# 7) Attente robuste (SSOT):
# A) Attendre l'ouverture du port HTTPS sur le reverse-proxy (443)
# B) Vérifier l'endpoint applicatif via le FQDN (GitLab réellement prêt)
#
# On NE teste PLUS 172.16.100.40:80 car Nginx Omnibus est désactivé et GitLab
# doit être atteint via le reverse-proxy (172.16.100.253) en HTTPS.
# -----------------------------------------------------------------------------

# A) Niveau réseau: le port 443 doit être accessible (évite "Connection refused")
- name: Attendre ouverture du port HTTPS GitLab (reverse-proxy)
  ansible.builtin.wait_for:
    host: "{{ gitlab_fqdn }}"
    port: "{{ gitlab_proxy_port | default(443) }}"
    delay: 5
    timeout: 900
  become: true

# B) Niveau applicatif: GitLab répond (200 sur /help, ou 302 sur /)
- name: Attendre GitLab via reverse-proxy (endpoint applicatif)
  ansible.builtin.uri:
    url: "{{ gitlab_scheme }}://{{ gitlab_fqdn }}{{ gitlab_healthcheck_path }}"
    method: GET
    status_code:
      - 200
      - 302
    validate_certs: "{{ gitlab_validate_certs | default(false) }}"
    timeout: 10
  register: gitlab_ready
  retries: 180
  delay: 10
  until: gitlab_ready.status in [200, 302]
  become: true

- name: Confirmation GitLab
  ansible.builtin.debug:
    msg: >
      GitLab est disponible à l'adresse
      {{ gitlab_scheme }}://{{ gitlab_fqdn }}
